#!/bin/zsh

# This script sets the desktop wallpaper using swww
# Usage: ./setwall.sh [image_path] [--blur <radius>]

# default blur radius
blur_radius=50

# parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --blur)
      blur_radius="$2"
      shift 2
      ;;
    *)
      wall="$1"
      shift
      ;;
  esac
done

# if no wallpaper provided, use fcf to pick one
if [[ -z "$wall" ]]; then
  wall=$(fd --type f --hidden --exclude .git  . ~/Pictures/Wall | fzf --height=40% --reverse --with-nth=-1 --preview '~/.local/bin/preview.sh {}' --delimiter='/' ) || return 
fi

# if still empty, exit
if [[ -z "$wall" ]]; then
  echo "No wallpaper selected."
  exit 1
fi

# check if swww daemon is running
if ! pgrep -x "swww-daemon" >/dev/null; then
  echo "Error: swww-daemon is not running."
  exit 1
fi

# set wallpaper
swww img -t fade "$wall"

# create blurred version
ffmpeg -loglevel quiet  -i "$wall" -vf "gblur=sigma=${blur_radius}" -y ~/Pictures/wall-blur.jpeg

# overlay blurred wallpaper
swww img -n overlay ~/Pictures/wall-blur.jpeg

# wait and clean up
echo "wallpaper changed"
