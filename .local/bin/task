#!/bin/bash

# Task manager script

TASK_FILE="$HOME/.tasks.md"

# Create task file if it doesn't exist
if [ ! -f "$TASK_FILE" ]; then
    touch "$TASK_FILE"
fi

# Function to display usage
usage() {
    echo "Usage: task <command> [arguments]"
    echo
    echo "Commands:"
    echo "  add <text>    					- Add a new task"
    echo "  ls            					- List all tasks"
    echo "  done <number> 					- Mark a task as complete"
    echo "  undo <number> 					- Mark a task as pending"
    echo "  rm <number>   					- Remove a task"
	 echo "  shift <number> <number> 	-rearrange a task to a new position" 
    echo "  help          					- Show this help message"
}

# Main command logic
case "$1" in
    add)
        shift
        if [ -z "$*" ]; then
            echo "Error: Task text cannot be empty."
            exit 1
        fi
        echo "☐ $*" >> "$TASK_FILE"
        echo "Task added."
        ;;

    ls|list)
        if [ ! -s "$TASK_FILE" ]; then
            echo "No tasks yet. Add one with 'task add <text>'."
        else
			   if nl -w2 -s" " "$TASK_FILE" | grep -q '☑'; then
				  # print the completed task line as green color 
				  nl -w2 -s" " "$TASK_FILE" | sed -e 's/.*☑.*/\x1b[32m&\x1b[0m/'
				else
				  # print the incomplete task as red color
				  nl -w2 -s" " "$TASK_FILE" | sed -e 's/☐/\x1b[31m☐\x1b[0m/g'
				 fi
        fi
        ;;

    done|complete)
        if ! [[ "$2" =~ ^[0-9]+$ ]]; then
            echo "Error: Please provide a valid task number."
            exit 1
        fi
        if ! sed -i "${2}s/☐/☑/" "$TASK_FILE"; then
            echo "Error: Could not mark task $2 as done. Invalid task number or task already done?"
            exit 1
		  fi
        echo "Task $2 marked as done."
        ;;

    undo)
        if ! [[ "$2" =~ ^[0-9]+$ ]]; then
            echo "Error: Please provide a valid task number."
            exit 1
        fi
        if ! sed -i "${2}s/☑/☐/" "$TASK_FILE"; then
            echo "Error: Could not undo task $2. Invalid task number or task not done?"
            exit 1
		  fi
        echo "Task $2 marked as pending."
        ;;

    rm|remove)
        if ! [[ "$2" =~ ^[0-9]+$ ]]; then
            echo "Error: Please provide a valid task number."
            exit 1
        fi
        if ! sed -i "${2}d" "$TASK_FILE"; then
            echo "Error: Could not remove task $2. Invalid task number?"
            exit 1
		  fi
        echo "Task $2 removed."
        ;;
	 shift)
				if ! [[ "$2" =~ ^[0-9]+$ ]] || ! [[ "$3" =~ ^[0-9]+$ ]]; then
						echo "Error: Please provide valid task numbers."
						exit 1
				fi
				TASK_CONTENT=$(sed -n "${2}p" "$TASK_FILE")
				if [ -z "$TASK_CONTENT" ]; then
						echo "Error: Task $2 does not exist."
						exit 1
				fi
				sed -i "${2}d" "$TASK_FILE"
				sed -i "${3}i $TASK_CONTENT" "$TASK_FILE"
				echo "Task $2 moved to position $3."
				;;
    
    help)
        usage
        ;;

    *)
        usage
        ;;
esac
